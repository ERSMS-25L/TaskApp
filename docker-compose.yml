version: '3.8'

services:
  user-service:
    build:
      context: ./user-service
    environment:
      - PYTHONPATH=/app
      - DATABASE_URL=sqlite:////data/sqlite_user.db  # Use SQLite and a path within the volume
      - FIREBASE_CREDENTIALS_JSON=${FIREBASE_CREDENTIALS_JSON:-}
    ports:
      - "8001:8000"
    volumes:
      - user_data:/data  # Persistent volume for user service

  task-service:
    build:
      context: ./task-service
    environment:
      - PYTHONPATH=/app
      - DATABASE_URL=sqlite:////data/sqlite_task.db  # Use SQLite and a path within the volume
    ports:
      - "8002:8000"
    volumes:
      - task_data:/data  # Persistent volume for task service

  notification-service:
    build:
      context: ./notification-service
    environment:
      - PYTHONPATH=/app
      - DATABASE_URL=sqlite:////data/sqlite_notification.db  # Use SQLite and a path within the volume
      - MAILGUN_API_KEY=${MAILGUN_API_KEY:-}
      - MAILGUN_URL=${MAILGUN_URL:-}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:3000}
    ports:
      - "8003:8000"
    volumes:
      - notification_data:/data  # Persistent volume for notification service

  donation-service:
    build:
      context: ./donation-service
    environment:
      - PYTHONPATH=/app
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-sk_test_...}
      - STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY:-pk_test_...}
      - DONATION_SUCCESS_URL=${DONATION_SUCCESS_URL:-http://localhost:3000/success}
      - DONATION_CANCEL_URL=${DONATION_CANCEL_URL:-http://localhost:3000/cancel}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:3000}
    ports:
      - "8004:8000"

  frontend:
    build:
      context: ./frontend
    environment:
      - REACT_APP_USER_SERVICE_URL=http://localhost:8001
      - REACT_APP_TASK_SERVICE_URL=http://localhost:8002
      - REACT_APP_NOTIFICATION_SERVICE_URL=http://localhost:8003
      - REACT_APP_DONATION_SERVICE_URL=http://localhost:8004
      - REACT_APP_FIREBASE_API_KEY=${REACT_APP_FIREBASE_API_KEY:-}
      - REACT_APP_FIREBASE_AUTH_DOMAIN=${REACT_APP_FIREBASE_AUTH_DOMAIN:-}
      - REACT_APP_FIREBASE_PROJECT_ID=${REACT_APP_FIREBASE_PROJECT_ID:-}
      - REACT_APP_FIREBASE_APP_ID=${REACT_APP_FIREBASE_APP_ID:-}
    ports:
      - "3000:3000"
    depends_on:
      - user-service
      - task-service
      - notification-service
      - donation-service

volumes:
  user_data:  # Volume for user service data
  task_data:  # Volume for task service data
  notification_data:  # Volume for notification service data
